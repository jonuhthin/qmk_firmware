#include QMK_KEYBOARD_H

#define _BASE 0
#define _NUM 1
#define _MOUSE 2

// Define the keycode, `QK_USER` avoids collisions with existing keycodes
enum keycodes {
  KC_CYCLE_LAYERS = QK_USER,
};

// 1st layer on the cycle
#define LAYER_CYCLE_START 0
// Last layer on the cycle
#define LAYER_CYCLE_END   2

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {

	[_BASE] = LAYOUT(
		KC_ESC, KC_ESC, KC_DEL, KC_BSPC, 
		QK_USER, KC_CALCULATOR, KC_PGUP, KC_SPC, 
		KC_F11, KC_UP, KC_F5, KC_VOLU, 
		KC_LEFT, KC_DOWN, KC_RGHT, KC_VOLD, 
		KC_MPRV, KC_MEDIA_PLAY_PAUSE, KC_MNXT, KC_SYSTEM_SLEEP, 
		KC_LALT, KC_TAB, KC_RGUI, KC_ENT),
	[_NUM] = LAYOUT(
		KC_ESC, KC_ESC, KC_DEL, KC_BSPC, 
		QK_USER, KC_KP_SLASH, KC_KP_ASTERISK, KC_KP_MINUS, 
		KC_7, KC_8, KC_9, KC_KP_PLUS,
		KC_4, KC_5, KC_6, KC_KP_PLUS, 
		KC_1, KC_2, KC_3, KC_ENT,
		KC_DOT, KC_0, KC_COMMA, KC_ENT),
	[_MOUSE] = LAYOUT(
		KC_ESC, KC_ESC, KC_DEL, KC_BSPC, 
		QK_USER, KC_CALCULATOR, KC_PGUP, KC_SPC, 
		KC_MS_WH_LEFT, KC_MS_UP, KC_MS_WH_RIGHT, KC_MS_WH_UP, 
		KC_MS_LEFT, KC_MS_DOWN, KC_MS_RIGHT, KC_MS_WH_DOWN, 
		KC_MS_BTN1, KC_MS_BTN2, KC_MS_WH_DOWN, KC_SYSTEM_SLEEP, 
		KC_LALT, KC_TAB, KC_RGUI, KC_ENT),
};

static bool encoder_was_pressed = 0;
static uint16_t encoder_last_pressed_time = 0;

#define ROTARY_SW D4


void matrix_init_user(void) {
	gpio_set_pin_input_high(ROTARY_SW);
}

void encoder_single_click(void) {
  tap_code(KC_MUTE);
}

void matrix_scan_user(void) {
    bool encoder_is_pressed = (readPin(ROTARY_SW) == 0);

    if (encoder_is_pressed && !encoder_was_pressed && timer_elapsed(encoder_last_pressed_time) > 5) {
        encoder_single_click();
        encoder_last_pressed_time = timer_read();
    }

    encoder_was_pressed = encoder_is_pressed;
}

static uint8_t key_pressed = 0;
static uint8_t alternate_side = 0;

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
  
  key_pressed=record->event.pressed ? 1 : 0;
  if(key_pressed) {alternate_side = !alternate_side;}

  switch (keycode) {
    case KC_CYCLE_LAYERS:
      // Our logic will happen on presses, nothing is done on releases
      if (!record->event.pressed) { 
        // We've already handled the keycode (doing nothing), let QMK know so no further code is run unnecessarily
        return false;
      }

      uint8_t current_layer = get_highest_layer(layer_state);

      // Check if we are within the range, if not quit
      if (current_layer > LAYER_CYCLE_END || current_layer < LAYER_CYCLE_START) {
        return false;
      }

      uint8_t next_layer = current_layer + 1;
      if (next_layer > LAYER_CYCLE_END) {
          next_layer = LAYER_CYCLE_START;
      }
      layer_move(next_layer);
      return false;

    // Process other keycodes normally
    default:
      return true;
  }
}


#ifdef OLED_ENABLE

static const char PROGMEM bongo_release[] = {
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,192,192, 96, 96, 48, 48, 24, 12,  6, 14, 60,112, 96,224,192,192,192,192,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,192,192,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,192,240,124, 12, 12, 12, 12, 24,120,108, 14,  7,  3,  1,  0,128,192,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  3,  3,  7,  6, 14, 12, 28, 24, 48, 48, 24, 24, 12,252,252,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,  0,  1,  1,  1,  1,  3,  3,  3,  3,  7,  6,  6,  6,  6, 12, 12, 15, 15, 24, 24, 24, 24, 48, 48, 48, 48,112, 96, 96, 96,224,193,193,193,192,131,134,134,134, 12, 12,  0,  0,  0,  0,  0, 48, 56, 16,240,252, 12,  6,134,  6, 12, 60, 48, 32,  0,  0, 48,126,239,131,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  3,  3,  3,  3,  3,  6,  6,  6,  6, 12, 12, 15, 15, 24, 24, 24, 24, 56, 48, 48, 48,112, 96, 96, 96,225,207,254,248,192,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,
};
static const char PROGMEM bongo_press_r[] = {
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,192,192, 96, 96, 48, 48, 24, 12,  6, 14, 60,112, 96,224,192,192,192,192,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,192,192,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,192,240,124, 12, 12, 12, 12, 24,120,108, 14,  7,  3,  1,  0,128,192,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  3,  3,  7,  6, 14, 12, 28, 24, 48, 48, 24, 24, 12,252,252,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,  0,  1,  1,  1,  1,  3,  3,  3,  3,  7,  6,  6,  6,  6, 12, 12, 15, 15, 24, 24, 24, 24, 48, 48, 48, 48,112, 96, 96, 96,224,193,193,193,192,131,134,134,134, 12, 12,  0,  0,  0,  0,  0, 48, 56, 48,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 48,126,239,131,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  3,  3,  3,  3,  3,  6,  6, 22,126,111,227,192,224, 96, 96, 96, 96,112, 48, 48, 48,112, 96, 96, 96,225,207,254,248,192,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,
};
static const char PROGMEM bongo_press_l[] = {
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,192,192, 96, 96, 48, 48, 24, 12,  6, 14, 60,112, 96,224,192,192,192,192,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,192,192,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,192, 96, 48, 24, 12, 14,  7,  3,  1,  0,128,192,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  3,  3,  7,  6, 14, 12, 28, 24, 48, 48, 24, 24, 12,252,252,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,  0,  1,  1,  1,  1,  3,  3,  3,  3,  7,  6,  6,  6,  6, 12, 12,124,252,206,131,129,192,192,192,192,224, 96, 96, 96, 96,224,193,193,193,192,131,134,134,134, 12, 12,  0,  0,  0,  0,  0, 48, 56, 16,240,252, 12,  6,134,  6, 12, 60, 48, 32,  0,  0, 48,126,239,131,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  3,  3,  3,  3,  3,  6,  6,  6,  6, 12, 12, 15, 15, 24, 24, 24, 24, 56, 48, 48, 48,112, 96, 96, 96,225,207,254,248,192,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,
};
static const char PROGMEM bongo_press_lr[] = {
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,128,192,192, 96, 96, 48, 48, 24, 12,  6, 14, 60,112, 96,224,192,192,192,192,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,192,192,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,128,192, 96, 48, 24, 12, 14,  7,  3,  1,  0,128,192,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  3,  3,  7,  6, 14, 12, 28, 24, 48, 48, 24, 24, 12,252,252,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,  0,  1,  1,  1,  1,  3,  3,  3,  3,  7,  6,  6,  6,  6, 12, 12,124,252,206,131,129,192,192,192,192,224, 96, 96, 96, 96,224,193,193,193,192,131,134,134,134, 12, 12,  0,  0,  0,  0,  0, 48, 56, 48,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 48,126,239,131,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1,  3,  3,  3,  3,  3,  6,  6, 22,126,111,227,192,224, 96, 96, 96, 96,112, 48, 48, 48,112, 96, 96, 96,225,207,254,248,192,128,128,128,128,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
    0,
};

static const char PROGMEM layer[][116] = {
    [0] = {
        248,  0,  0,  0,  0,  0,  0,160,160,192,  0,  0, 96,128,128,128,224,  0,192,160,160,160,192,  0,224, 64, 32, 32, 64,
          3,  2,  2,  2,  2,  0,  1,  2,  2,  3,  2,128,130,132,132,132,131,  0,  1,  2,  2,  2,  0,  0,  3,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,  0,254,254,129,129, 97, 97, 25, 25,254,254,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,  0,  7,  7, 25, 25, 24, 24, 24, 24,  7,  7,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    },
    [1] = {
        248,  0,  0,  0,  0,  0,  0,160,160,192,  0,  0, 96,128,128,128,224,  0,192,160,160,160,192,  0,224, 64, 32, 32, 64,
          3,  2,  2,  2,  2,  0,  1,  2,  2,  3,  2,  0,  2,132,132,  4,  3,  0,  1,  2,  2,  2,  0,  0,  3,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  6,  6,255,255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 24, 24, 31, 31, 24, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    },
    [2] = {
        248,  0,  0,  0,  0,  0,  0,160,160,192,  0,  0, 96,128,128,128,224,  0,192,160,160,160,192,  0,224, 64, 32, 32, 64,
          3,  2,  2,  2,  2,  0,  1,  2,  2,  3,  2,128,130,132,132,132,131,  0,  1,  2,  2,  2,  0,  0,  3,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,  0,134,134, 97, 97, 97, 97, 97, 97, 30, 30,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
          0,  0,  0,  0,  0,  0,  0,  0,  0, 31, 31, 24, 24, 24, 24, 24, 24, 24, 24,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    }//,
    // [3] = {
    //     248,  0,  0,  0,  0,  0,  0,160,160,192,  0,  0, 96,128,128,128,224,  0,192,160,160,160,192,  0,224, 64, 32, 32, 64,
    //       3,  2,  2,  2,  2,  0,  1,  2,  2,131,130,128,130,132,132,132,131,128,129,  2,  2,  2,  0,  0,  3,  0,  0,  0,  0,
    //       0,  0,  0,  0,  0,  0,  0,  0,  0,  1,  1,  1,  1, 97, 97,121,121,135,135,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    //       0,  0,  0,  0,  0,  0,  0,  0,  0,  6,  6, 24, 24, 24, 24, 24, 24,  7,  7,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,
    // }
};

oled_rotation_t oled_init_user(oled_rotation_t rotation) { return OLED_ROTATION_180; }
bool oled_task_user(void) {
    // switch (get_highest_layer(layer_state)) {
    //   case _BASE:
    //       oled_write_ln("BASE",false);
    //       break;
    //   case _NUM:
    //       oled_write_ln("NUM",false);
    //       break;
    //   case _MOUSE:
    //       oled_write_ln("MOUSE",false);
    //       break;
    //   default:
    //       // Or use the write_ln shortcut over adding '\n' to the end of your string
    //       oled_write_ln("Undefined",false);
    // }

    char buffer[512];
    if (key_pressed) 
        memcpy_P(buffer, alternate_side ? bongo_press_r: bongo_press_l, 512);
    else
        memcpy_P(buffer, bongo_release, 512);

    int highest_layer = 0;
    for(int i=3;i>=0;--i){
        if (IS_LAYER_ON(i)) {
            highest_layer = i;
            break;
        }
    }
    // Apply the layer info (4*29)
    for(int i=0;i<4;i++){
        for(int j=0;j<29;j++){
            buffer[i*128+85+j] = pgm_read_byte_near(layer[highest_layer]+i*29+j);
        }
    }

    oled_write_raw(buffer, 512);
    return false;
}
#endif